# ğŸ”§ Fix: Admin Login "Data Pengguna Tidak Ditemukan"

## ğŸ“‹ Masalah
Login admin gagal dengan pesan error:
```
âŒ Data pengguna tidak ditemukan
```

Padahal email dan password sudah benar.

## ğŸ” Penyebab
1. **Firebase Auth berhasil** - Email & password valid
2. **Firestore lookup gagal** - Document tidak ditemukan berdasarkan Firebase Auth UID
3. **Alasan:** Admin dibuat dengan `create_admin.dart` yang menggunakan auto-generated ID, bukan Firebase Auth UID

### Ilustrasi Masalah:
```
Firebase Auth:
  UID: "abc123xyz" â† Login berhasil

Firestore Collection "users":
  Document ID: "autoGenerated456" â† Dicari dengan UID "abc123xyz" â†’ TIDAK KETEMU!
  â”œâ”€ email: "admin@jawara.com"
  â”œâ”€ password: "hashed..."
  â””â”€ role: "admin"
```

## âœ… Solusi Yang Diterapkan

### 1. File: `lib/core/providers/auth_provider.dart`

**Penambahan: Fallback Query by Email**

```dart
// Get user data from Firestore using UID
var user = await _firestoreService.getUserById(
  userCredential.user!.uid,
);

// âœ¨ FALLBACK: Jika tidak ditemukan by UID, cari by email
if (user == null && userCredential.user!.email != null) {
  user = await _firestoreService.getUserByEmail(
    userCredential.user!.email!,
  );
  
  if (user != null) {
    // âœ… User ditemukan dengan email! (Legacy admin)
  }
}
```

**Keuntungan:**
- âœ… Backward compatible - admin lama tetap bisa login
- âœ… Admin baru tetap optimal (pakai UID)
- âœ… Tidak perlu migrasi data

### 2. File: `lib/core/services/firestore_service.dart`

**Penambahan: Enhanced Logging**

```dart
Future<UserModel?> getUserById(String userId) async {
  print('ğŸ” Getting user by ID: $userId');
  
  final doc = await _firestore.collection('users').doc(userId).get();
  
  if (!doc.exists) {
    print('âŒ Document not found');
    print('â„¹ï¸  This might be a legacy admin');
    return null;
  }
  
  return UserModel.fromMap(doc.data()!, doc.id);
}
```

## ğŸ§ª Testing

1. **Jalankan aplikasi:**
   ```bash
   flutter run -d windows
   ```

2. **Login dengan kredensial admin:**
   
   **Admin 1 (Legacy):**
   - Email: `admin@jawara.com`
   - Password: `admin123`
   
   **Admin 2 (NEW - Firebase Auth):**
   - Email: `admin2@jawara.com`
   - Password: `admin123`

3. **Perhatikan log di terminal:**
   ```
   === LOGIN ATTEMPT ===
   Email: admin2@jawara.com
   ğŸ” Signing in with Firebase Auth...
   âœ… Firebase Auth successful!
   Firebase UID: abc123xyz
   ğŸ” Getting user data from Firestore...
   
   âœ… User found by UID! (Document ID matches Firebase UID)
   
   âœ… LOGIN BERHASIL!
   ```

## ğŸ“Š Status Flow

### Sebelum Fix:
```
Login â†’ Firebase Auth âœ… â†’ Firestore (by UID) âŒ â†’ ERROR: "Data tidak ditemukan"
```

### Setelah Fix:
```
Login â†’ Firebase Auth âœ… â†’ Firestore (by UID) âŒ â†’ Fallback (by Email) âœ… â†’ SUCCESS! ğŸ‰
```

## ğŸ’¡ Tips Untuk Kedepannya

### ğŸ†• Membuat Admin Baru: admin2@jawara.com

File `create_admin.dart` sudah diperbaiki untuk membuat admin di **Firebase Auth** dan **Firestore** dengan document ID yang sama.

#### **Cara 1: Otomatis (Saat Aplikasi Running)**

1. **Buka aplikasi:**
   ```bash
   flutter run -d windows
   ```

2. **Kode sudah ditambahkan di `main.dart`** untuk otomatis membuat admin2@jawara.com saat startup

3. **Perhatikan console output:**
   ```
   ğŸ”§ Checking/Creating admin2@jawara.com...
   ğŸ”§ Membuat admin: admin2@jawara.com
   ğŸ“ Creating user in Firebase Auth...
   âœ… User created in Firebase Auth!
   ğŸ“ Creating user in Firestore...
   âœ… User created in Firestore!
   
   ğŸ‰ Admin berhasil dibuat!
   ğŸ“§ Email:    admin2@jawara.com
   ğŸ”‘ Password: admin123
   ```

4. **Setelah berhasil, COMMENT kode di `main.dart` (line 68-77)** untuk menghindari error saat startup berikutnya

#### **Cara 2: Manual via Firebase Console**

Jika Cara 1 error, ikuti langkah berikut:

**A. Buat di Firebase Authentication:**
1. Buka [Firebase Console](https://console.firebase.google.com/)
2. Pilih project Anda
3. Go to **Authentication** â†’ **Users** tab
4. Click **Add User**
5. Email: `admin2@jawara.com`
6. Password: `admin123`
7. Click **Add User**
8. **COPY UID user yang baru dibuat** (contoh: `abc123xyz456`)

**B. Buat di Firestore:**
1. Go to **Firestore Database**
2. Collection: `users`
3. Click **Add Document**
4. **Document ID:** Paste UID dari step A.8 (PENTING!)
5. Add fields:
   ```
   email: "admin2@jawara.com"
   password: "8c6976e5b5410415bde908bd4dee15dfb167a9c873fc4bb8a81f6f2ab448a918"
   nama: "Admin 2 Jawara"
   nik: "3201234567890123"
   jenisKelamin: "Laki-laki"
   noTelepon: "081234567899"
   alamat: "Jl. Admin 2 No. 123"
   role: "admin"
   status: "approved"
   createdAt: [Current timestamp]
   updatedAt: null
   ```
   
   **Note:** Password di atas adalah hash SHA-256 untuk "admin123"

6. Click **Save**

**C. Test Login:**
```
Email: admin2@jawara.com
Password: admin123
```

### Membuat Admin Baru (Recommended Way)

Gunakan `create_admin.dart` yang sudah diperbaiki, tapi pastikan:

1. **Buat akun di Firebase Auth dulu** (via Firebase Console atau code)
2. **Gunakan Firebase Auth UID sebagai document ID** di Firestore

Atau biarkan sistem sekarang yang handle dengan fallback query.

### Jika Masih Error

1. **Cek Firebase Auth:**
   - Buka Firebase Console â†’ Authentication
   - Pastikan email admin terdaftar

2. **Cek Firestore:**
   - Buka Firebase Console â†’ Firestore Database
   - Collection: `users`
   - Cari document dengan email admin Anda
   - Pastikan field berikut ada:
     - `email`: "admin@jawara.com"
     - `password`: (hashed, 64 karakter)
     - `role`: "admin"
     - `status`: "approved"
     - `nama`: nama admin

3. **Test dengan logging:**
   ```bash
   flutter run -d windows --verbose
   ```
   
   Perhatikan output di terminal untuk detail error.

## ğŸ”’ Keamanan

- âœ… Password tetap di-hash dengan SHA-256
- âœ… Tidak ada data sensitif di log (production)
- âœ… Firebase Auth tetap sebagai gatekeeper utama
- âœ… Fallback query aman karena tetap validasi role & status

## ğŸ“ File Yang Dimodifikasi

1. `lib/core/providers/auth_provider.dart` - Tambah fallback query
2. `lib/core/services/firestore_service.dart` - Enhanced logging

**Tidak ada file baru yang dibuat!** âœ…

---

**Status:** âœ… FIXED
**Tested:** Menunggu konfirmasi user
**Last Updated:** 27 November 2025

