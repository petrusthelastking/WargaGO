rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // ========================================================================
    // SECURE RULES FOR CUSTOM AUTHENTICATION
    // ========================================================================
    // Rules ini untuk app dengan custom authentication (tanpa Firebase Auth)
    // Security bergantung pada:
    // 1. Password hashing (SHA-256) - password tidak bisa dilihat
    // 2. Data validation - format data harus benar
    // 3. App-layer authorization - role checking di aplikasi
    // ========================================================================

    // Helper function - check if data is valid
    function hasValidData() {
      return request.resource.data != null;
    }

    // ========================================================================
    // USERS COLLECTION - Password harus di-hash SHA-256
    // ========================================================================
    match /users/{userId} {
      // Read: Semua bisa read (untuk login verification)
      // Password sudah di-hash SHA-256 (64 char hex) jadi AMAN dilihat
      allow read: if true;

      // Create: Hanya registrasi dengan password ter-hash
      allow create: if hasValidData() &&
                       'email' in request.resource.data &&
                       'password' in request.resource.data &&
                       request.resource.data.password is string &&
                       request.resource.data.password.size() == 64 && // SHA-256 hash
                       request.resource.data.password.matches('^[a-f0-9]+$'); // Hex only

      // Update: Harus ada updatedAt, tidak boleh ubah email/nik
      allow update: if hasValidData() &&
                       'updatedAt' in request.resource.data &&
                       !('email' in request.resource.data.diff(resource.data).affectedKeys()) &&
                       !('nik' in request.resource.data.diff(resource.data).affectedKeys());

      // Delete: Allow (check authorization di app)
      allow delete: if true;
    }

    // ========================================================================
    // WARGA COLLECTION - Data Penduduk
    // ========================================================================
    match /warga/{wargaId} {
      // Read: Semua bisa lihat (transparansi data warga)
      allow read: if true;

      // Create: Harus ada nama dan NIK
      allow create: if hasValidData() &&
                       'name' in request.resource.data &&
                       request.resource.data.name is string &&
                       request.resource.data.name.size() > 0 &&
                       'nik' in request.resource.data;

      // Update: Harus ada updatedAt
      allow update: if hasValidData() &&
                       'updatedAt' in request.resource.data;

      // Delete: Allow (check di app)
      allow delete: if true;
    }

    // ========================================================================
    // RUMAH, MUTASI, PENDING_WARGA - Basic validation
    // ========================================================================
    match /rumah/{rumahId} {
      allow read: if true;
      allow create: if hasValidData() && 'alamat' in request.resource.data;
      allow update: if hasValidData();
      allow delete: if true;
    }

    match /mutasi/{mutasiId} {
      allow read: if true;
      allow create: if hasValidData() && 'nama' in request.resource.data;
      allow update: if hasValidData();
      allow delete: if true;
    }

    match /pending_warga/{pendingId} {
      allow read: if true;
      allow create: if hasValidData() && 'name' in request.resource.data;
      allow update: if hasValidData();
      allow delete: if true;
    }

    // ========================================================================
    // AGENDA COLLECTION
    // ========================================================================
    match /agenda/{agendaId} {
      allow read: if true;
      allow create: if hasValidData() &&
                       ('title' in request.resource.data || 'judul' in request.resource.data);
      allow update: if hasValidData();
      allow delete: if true;

      match /broadcasts/{broadcastId} {
        allow read, write: if true;
      }
    }

    // ========================================================================
    // KEUANGAN COLLECTION - Transparansi keuangan dengan validasi
    // ========================================================================
    match /keuangan/{transactionId} {
      allow read: if true; // Transparansi

      // Create: Amount harus > 0
      allow create: if hasValidData() &&
                       'amount' in request.resource.data &&
                       request.resource.data.amount is number &&
                       request.resource.data.amount > 0;

      allow update: if hasValidData();
      allow delete: if true;

      match /pemasukan/{pemasukanId} {
        allow read: if true;
        allow write: if true;
      }

      match /pengeluaran/{pengeluaranId} {
        allow read: if true;
        allow write: if true;
      }
    }

    // ========================================================================
    // JENIS IURAN COLLECTION - Validasi nominal > 0
    // ========================================================================
    match /jenis_iuran/{jenisIuranId} {
      allow read: if true;

      // Create: Nama dan jumlah harus ada dan valid
      allow create: if hasValidData() &&
                       'namaIuran' in request.resource.data &&
                       request.resource.data.namaIuran is string &&
                       request.resource.data.namaIuran.size() > 0 &&
                       'jumlahIuran' in request.resource.data &&
                       request.resource.data.jumlahIuran is number &&
                       request.resource.data.jumlahIuran > 0;

      allow update: if hasValidData();
      allow delete: if true;
    }

    // ========================================================================
    // TAGIHAN COLLECTION - AMAN dengan validasi ketat
    // ========================================================================
    match /tagihan/{tagihanId} {
      // Read: Semua bisa lihat (transparansi tagihan)
      allow read: if true;

      // Create: Validasi field wajib dan nilai valid
      allow create: if hasValidData() &&
                       // Field wajib harus ada
                       'jenisIuranId' in request.resource.data &&
                       'jenisIuranName' in request.resource.data &&
                       'keluargaId' in request.resource.data &&
                       'keluargaName' in request.resource.data &&
                       'nominal' in request.resource.data &&
                       'periode' in request.resource.data &&
                       'status' in request.resource.data &&
                       'isActive' in request.resource.data &&
                       // Validasi tipe data
                       request.resource.data.jenisIuranName is string &&
                       request.resource.data.keluargaName is string &&
                       request.resource.data.nominal is number &&
                       request.resource.data.periode is string &&
                       // Validasi nilai
                       request.resource.data.nominal > 0 &&
                       request.resource.data.periode.size() > 0 &&
                       request.resource.data.status in ['Belum Dibayar', 'Lunas', 'Terlambat'] &&
                       request.resource.data.isActive == true;

      // Update: Tidak boleh ubah field immutable
      allow update: if hasValidData() &&
                       'updatedAt' in request.resource.data &&
                       // Field immutable tidak boleh diubah
                       !('kodeTagihan' in request.resource.data.diff(resource.data).affectedKeys()) &&
                       !('jenisIuranId' in request.resource.data.diff(resource.data).affectedKeys()) &&
                       !('keluargaId' in request.resource.data.diff(resource.data).affectedKeys()) &&
                       !('nominal' in request.resource.data.diff(resource.data).affectedKeys()) &&
                       !('periode' in request.resource.data.diff(resource.data).affectedKeys());

      // Delete: Allow (soft delete dengan isActive di app)
      allow delete: if true;
    }

    // ========================================================================
    // COLLECTIONS LAIN - Basic validation
    // ========================================================================
    match /pemasukan_lain/{pemasukanLainId} {
      allow read: if true;
      allow create: if hasValidData() && 'nominal' in request.resource.data;
      allow update, delete: if true;
    }

    match /mutasi_warga/{mutasiId} {
      allow read: if true;
      allow create: if hasValidData() && 'type' in request.resource.data;
      allow update, delete: if true;
    }

    match /notifications/{notificationId} {
      allow read: if true;
      allow create: if hasValidData() && 'userId' in request.resource.data;
      allow update, delete: if true;
    }

    match /settings/{settingId} {
      allow read, write: if true;
    }

    match /dashboard_stats/{statId} {
      allow read, write: if true;
    }

    // ========================================================================
    // SECURITY NOTES
    // ========================================================================
    // üîí PASSWORD SECURITY:
    //    - Password WAJIB di-hash SHA-256 sebelum disimpan (64 char hex)
    //    - Rules memvalidasi password adalah hash, bukan plaintext
    //    - Password hash aman dilihat karena tidak bisa di-reverse
    //
    // üîê DATA VALIDATION:
    //    - Rules enforce tipe data dan format yang benar
    //    - Field immutable dilindungi dari perubahan
    //    - Nominal harus positif, string tidak boleh kosong
    //
    // üë• AUTHORIZATION:
    //    - Role-based access control dilakukan di app layer
    //    - Rules fokus pada data validation, bukan authorization
    //    - Admin/petugas check di aplikasi sebelum operasi sensitive
    //
    // ‚úÖ KEAMANAN:
    //    - Semua collection punya validasi dasar
    //    - Tidak ada catch-all rule (default deny)
    //    - Field sensitive (email, NIK) protected dari update
    //    - Password harus hash SHA-256 (tidak bisa plaintext)
    //
    // ========================================================================
  }
}

