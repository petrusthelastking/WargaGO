name: Build and Deploy Flutter Android App

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: write  # needed if you want to commit back changes like version bumps

jobs:
  build:
    environment: Distribution
    runs-on: ubuntu-latest

    # 1. Checkout repository
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # needed if you push version bumps back

      # 2. Setup Java (required by Android build tools)
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'

      # 3. Setup Flutter
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.38.0'
          channel: 'stable'

      # 4. Automatically bump build number
      - name: Bump Flutter build version
        run: |
          # Extract current version (format: x.y.z+build)
          current_version=$(grep '^version:' pubspec.yaml | sed 's/version: //')
          version_name=$(echo $current_version | cut -d+ -f1)
          build_number=$(echo $current_version | cut -d+ -f2)
          
          # Increment build number
          new_build_number=$((build_number + 1))
          new_version="$version_name+$new_build_number"
          
          # Replace in pubspec.yaml
          sed -i "s/version: .*/version: $new_version/" pubspec.yaml
          
          echo "Updated version to $new_version"
          
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add pubspec.yaml
          git diff-index --quiet HEAD || git commit -m "chore: bump version [skip ci]"
          
          # Pull latest changes and rebase before pushing
          git pull --rebase origin ${{ github.ref_name }} || true
          git push origin HEAD:${{ github.ref }} || echo "Push failed, but continuing workflow"

      # 5. Create .env file for production build with all secrets
      - name: Create .env file
        env:
          FIREBASE_API_KEY_WEB: ${{ vars.FIREBASE_API_KEY_WEB }}
          TEST_EMAIL: ${{ vars.TEST_EMAIL }}
          TEST_PASSWORD: ${{ vars.TEST_PASSWORD }}
          PCVK_API_URL: ${{ vars.PCVK_API_URL }}
          PCVK_API_HTTPS: ${{ vars.PCVK_API_HTTPS }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}

        run: |
          cp .env.example .env
          # Syntax: sed -i 's|^KEY_TO_FIND=.*|KEY_TO_FIND=new_value|' filename                    
          # Inject secrets into .env file
          sed -i "s|^FIREBASE_API_KEY_WEB=.*|FIREBASE_API_KEY_WEB=$FIREBASE_API_KEY_WEB|" .env
          sed -i "s|^TEST_EMAIL=.*|TEST_EMAIL=$TEST_EMAIL|" .env
          sed -i "s|^TEST_PASSWORD=.*|TEST_PASSWORD=$TEST_PASSWORD|" .env
          sed -i "s|^PCVK_API_URL=.*|PCVK_API_URL=$PCVK_API_URL|" .env
          sed -i "s|^PCVK_API_HTTPS=.*|PCVK_API_HTTPS=$PCVK_API_HTTPS|" .env
          sed -i "s|^GEMINI_API_KEY=.*|GEMINI_API_KEY=$GEMINI_API_KEY|" .env
          
          # Verify .env file was created with all keys
          echo "✅ .env file created with the following keys:"
          grep -E "^[A-Z_]+=" .env | sed 's/=.*/=***/' || echo "⚠️  Warning: .env might be empty"
      # 6. Get dependencies
      - name: Get dependencies
        run: flutter pub get

      # 7. Setup Keystore for Release Build
      - name: Decode Keystore
        env:
          KEYSTORE_BASE64: ${{ secrets.KEYSTORE_BASE64 }}
        run: |
          echo "Decoding keystore from base64..."
          echo "$KEYSTORE_BASE64" | base64 -d > android/app/upload-keystore.jks
          echo "✓ Keystore decoded successfully"

      - name: Create key.properties
        env:
          KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
          KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
          KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
        run: |
          echo "Creating key.properties..."
          cat > android/key.properties << EOF
          storePassword=$KEYSTORE_PASSWORD
          keyPassword=$KEY_PASSWORD
          keyAlias=$KEY_ALIAS
          storeFile=upload-keystore.jks
          EOF
          echo "✓ key.properties created"

      # 8. Build release APK
      - name: Build APK
        run: flutter build apk --release

      # 9. Upload APK to Firebase App Distribution
      - name: Upload APK to Firebase App Distribution
        uses: wzieba/Firebase-Distribution-Github-Action@v1
        with:
          appId: ${{ secrets.FIREBASE_APP_ID }}
          serviceCredentialsFileContent: ${{ secrets.CREDENTIAL_FILE_CONTENT }}
          groups: "kelompok-4, terter-outer"
          file: build/app/outputs/flutter-apk/app-release.apk
          releaseNotes: |
            Changes in this build:
            ${{ github.event.head_commit.message }}